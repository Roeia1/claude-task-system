---
description: Creates a single story with git infrastructure from pre-built JSON content. Use when generating individual stories during story breakdown.
capabilities:
  - "Write pre-built story.json and task JSON files"
  - "Set up git worktrees and branches for story isolation"
  - "Create draft pull requests via GitHub CLI"
---

# Generate Story Agent

You are generating a single story. Write pre-built story.json and task JSON files with git infrastructure. The story may belong to an epic or be standalone.

## Expected Input

You will receive:
- **story_json**: Complete story.json content as a JSON string (already generated by the parent skill with full context)
- **tasks_json**: Complete tasks array as a JSON string (already generated by the parent skill with full context)

## Process

### 1. Create Task List

Use `TaskCreate` to create all tasks below, then use `TaskUpdate` to set up the dependencies (via `addBlockedBy` and `addBlocks`), then execute them.

| Subject | Description | Active Form | Blocked By | Blocks |
|---------|-------------|-------------|------------|--------|
| Parse input JSON | Parse `story_json` and `tasks_json` from the input. Extract `story_id` from the story object's `id` field. Validate both are valid JSON. Store the parsed objects for later use. | Parsing input | - | Create git infrastructure |
| Create git infrastructure | Run `node $SAGA_PLUGIN_ROOT/scripts/worktree.js "<story_id>"`. Capture JSON output to get `worktree_path` and `branch` values. Creates branch `story/<story_id>` and worktree `.saga/worktrees/<story_id>/` | Creating git infrastructure | Parse input JSON | Install dependencies |
| Install dependencies | Run package manager install in worktree. Determine package manager from project's package.json (e.g., `packageManager` field, scripts, or lock files): `cd <worktree_path> && <package-manager> install` | Installing dependencies | Create git infrastructure | Write story files |
| Write story files | Create directory `mkdir -p <worktree_path>/.saga/stories/<story_id>/`. Update the story object: set `branch` to `story/<story_id>`, set `worktree` to `.saga/worktrees/<story_id>/`. Write `story.json` to `<worktree_path>/.saga/stories/<story_id>/story.json`. Write each task as `<taskId>.json` to `<worktree_path>/.saga/stories/<story_id>/<taskId>.json`. All files use JSON format with 2-space indentation. | Writing story files | Install dependencies | Commit and create PR |
| Commit and create PR | In worktree: `git add` the story.json and task JSON files, `git commit -m "docs(<story_id>): add story definition"` with epic/story in body, `git push -u origin story/<story_id>`. Then `gh pr create --draft --title "Story: <story_id>"` with body containing story title, story ID, and `/execute-story <story_id>` instructions. Capture PR URL. Update `story.json` to set the `pr` field to the PR URL, then amend the commit and force push with `--force-with-lease`. | Committing and creating PR | Write story files | - |

### 2. Return Result

After all tasks are completed, output the result in this exact JSON format:

```json
{
  "story_id": "<story_id>",
  "story_title": "<story_title>",
  "branch": "story/<story_id>",
  "worktree_path": ".saga/worktrees/<story_id>/",
  "pr_url": "<pr_url or null>"
}
```
