---
description: Creates a single story with full content and git infrastructure from an epic. Use when generating individual stories during story breakdown.
capabilities:
  - "Create self-contained story.json and task JSON files"
  - "Set up git worktrees and branches for story isolation"
  - "Create draft pull requests via GitHub CLI"
---

# Generate Story Agent

You are generating a single story for an epic. Create story.json and task JSON files with git infrastructure.

## Expected Input

You will receive:
- **epic_id**: The epic identifier
- **story_id**: The globally unique story identifier (pre-generated by the parent skill)
- **story_title**: Title for this story
- **story_description**: Brief description of what this story covers
- **other_stories**: Titles and descriptions of other stories being generated (to avoid overlap)

## Process

### 1. Create Task List

Use `TaskCreate` to create all tasks below, then use `TaskUpdate` to set up the dependencies (via `addBlockedBy` and `addBlocks`), then execute them.

| Subject | Description | Active Form | Blocked By | Blocks |
|---------|-------------|-------------|------------|--------|
| Create git infrastructure | Run `node $SAGA_PLUGIN_ROOT/scripts/worktree.js "<story_id>"`. Capture JSON output to get `worktree_path` and `branch` values. Creates branch `story/<story_id>` and worktree `.saga/worktrees/<story_id>/` | Creating git infrastructure | - | Install dependencies |
| Install dependencies | Run package manager install in worktree. Determine package manager from project's package.json (e.g., `packageManager` field, scripts, or lock files): `cd <worktree_path> && <package-manager> install` | Installing dependencies | Create git infrastructure | Write story files |
| Read epic context | Read `${SAGA_PROJECT_DIR}/.saga/epics/<epic_id>.json` to understand full context. Parse the JSON to extract `id`, `title`, `description` fields. The `description` field contains the epic's vision, architecture, goals, and scope. | Reading epic context | - | Generate story content |
| Generate story content | Design the story content as JSON structures. Story must be self-contained (understandable without reading epic). Use `other_stories` to avoid overlap, respect epic's scope boundaries. Generate: (1) A `story.json` object with fields: `id` (use `story_id`), `title` (use `story_title`), `description` (rich markdown with context, scope boundaries, interfaces, acceptance criteria), `epic` (use `epic_id`), `branch` (`story/<story_id>`), `pr` (set later), `worktree` (`.saga/worktrees/<story_id>/`). (2) An array of task objects, each with: `id` (e.g., `t1`, `t2`), `subject` (short task title), `description` (detailed description with guidance, references, pitfalls, done-when criteria), `activeForm` (present continuous form, e.g., "Implementing login form"), `status` (`pending`), `blockedBy` (array of task IDs this depends on). Tasks should be specific and atomic. | Generating story content | Read epic context | Write story files |
| Write story files | Create directory `mkdir -p <worktree_path>/.saga/stories/<story_id>/`. Write `story.json` to `<worktree_path>/.saga/stories/<story_id>/story.json`. Write each task as `<taskId>.json` to `<worktree_path>/.saga/stories/<story_id>/<taskId>.json`. All files use JSON format. | Writing story files | Generate story content, Install dependencies | Commit and create PR |
| Commit and create PR | In worktree: `git add` the story.json and task JSON files, `git commit -m "docs(<story_id>): add story definition"` with epic/story in body, `git push -u origin story/<story_id>`. Then `gh pr create --draft --title "Story: <story_id>"` with body containing story title, epic ID, story ID, and `/execute-story <story_id>` instructions. Capture PR URL. Update `story.json` to set the `pr` field to the PR URL, then amend the commit and force push. | Committing and creating PR | Write story files | - |

### 2. Return Result

After all tasks are completed, output the result in this exact JSON format:

```json
{
  "story_id": "<story_id>",
  "story_title": "<story_title>",
  "branch": "story/<story_id>",
  "worktree_path": ".saga/worktrees/<story_id>/",
  "pr_url": "<pr_url or null>"
}
```
