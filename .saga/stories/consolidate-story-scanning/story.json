{
  "id": "consolidate-story-scanning",
  "title": "Consolidate scanners into saga-utils with worktree support",
  "description": "## Overview\nConsolidate the three separate story-scanning implementations into a single shared `scanStories()` function in `@saga-ai/utils`, and add worktree scanning support so stories created inside worktrees are visible to the dashboard and `find.js`.\n\n## Problem\nCurrently there are 3 independent scanners that all do essentially the same work — read story JSON files, read their tasks, derive status, and detect worktree/journal paths:\n1. `listStories()` in `packages/saga-utils/src/storage.ts` — sync, returns raw `Story[]` without tasks or status\n2. `scanStories()` in `packages/saga-utils/src/scripts/find/saga-scanner.ts` — async, used by `find.js` for `/execute-story`\n3. `scanStories()` in `packages/dashboard/src/utils/saga-scanner.ts` — sync, used by the dashboard REST API\n\nNone of them scan `.saga/worktrees/<id>/.saga/stories/<id>/` for story data, so stories created by `create-story.js` (which writes to worktrees) are invisible to the dashboard and find command.\n\n## Solution\n1. **Add `scanStories()` to `@saga-ai/utils/storage.ts`** — A single function that:\n   - Scans `.saga/stories/` on the current branch (existing behavior)\n   - Scans `.saga/worktrees/<id>/.saga/stories/<id>/` for worktree stories (new)\n   - Reads tasks for each story and derives status using existing `listTasks()` and `deriveStoryStatus()`\n   - Detects worktree and journal paths\n   - When a story exists in both locations, the **worktree version takes priority** entirely (it has the latest execution state)\n   - Returns a `ScannedStory[]` type that captures all metadata both consumers need\n   - Export `scanStories()` and `ScannedStory` type from `index.ts`\n\n2. **Delete `packages/dashboard/src/utils/saga-scanner.ts`** — The dashboard's `parser.ts` imports `scanStories()` and `listEpics()` directly from `@saga-ai/utils`.\n\n3. **Delete `packages/saga-utils/src/scripts/find/saga-scanner.ts`** — The find command's `finder.ts` imports `scanStories()` directly from `../../storage.ts`. Move `storiesDirectoryExists()` and `epicsDirectoryExists()` helpers to `storage.ts` if they're still needed by `finder.ts`.\n\n4. **Update `parser.ts` `parseStory()`** — For single-story lookups (used by WebSocket real-time updates), try the worktree path first, then fall back to the main `.saga/stories/` path.\n\n5. **Update all consumers** — `finder.ts`, `parser.ts`, and any dashboard tests that imported from the deleted scanner files.\n\n## Key Design Decisions\n- **Worktree takes priority**: If a story ID appears in both `.saga/stories/` and `.saga/worktrees/<id>/.saga/stories/<id>/`, the worktree version wins entirely. This ensures the dashboard shows the latest task status during execution.\n- **No thin wrappers**: Consumers import directly from `@saga-ai/utils` — no intermediate scanner files.\n- **Sync function**: The new `scanStories()` should be sync (using `readdirSync`/`readFileSync`) to match `listStories()` and the dashboard's sync expectations. The find.js scanner was async but doesn't need to be.\n\n## Files to Modify\n- `packages/saga-utils/src/storage.ts` — Add `scanStories()`, `ScannedStory` type, `storiesDirectoryExists()`, `epicsDirectoryExists()`\n- `packages/saga-utils/src/index.ts` — Export new functions and types\n- `packages/saga-utils/src/scripts/find/finder.ts` — Import from `../../storage.ts` instead of `./saga-scanner.ts`\n- `packages/dashboard/src/server/parser.ts` — Import from `@saga-ai/utils` instead of local scanner, update `parseStory()`\n\n## Files to Delete\n- `packages/dashboard/src/utils/saga-scanner.ts`\n- `packages/saga-utils/src/scripts/find/saga-scanner.ts`\n\n## Test Files to Update/Consolidate\n- `packages/saga-utils/src/scripts/find/saga-scanner.test.ts` — Move relevant tests to storage.test.ts, delete file\n- `packages/dashboard/src/utils/__tests__/saga-scanner.test.ts` — Move relevant tests to saga-utils storage.test.ts, delete file\n- `packages/saga-utils/src/storage.test.ts` — Add `scanStories()` tests including worktree scanning\n- `packages/saga-utils/src/scripts/find/finder.test.ts` — Update imports if needed",
  "guidance": "Start by reading the existing scanner implementations and their test files to understand the full ScannedStory contract. The new `scanStories()` function should satisfy both consumer's needs. Use `readdirSync` for worktree directory discovery. The worktree scanning logic: iterate `.saga/worktrees/`, for each subdirectory check if `.saga/stories/<id>/story.json` exists inside it, and if so read it. Build a Map<storyId, ScannedStory> with worktree entries overwriting master entries.",
  "doneWhen": "A single `scanStories()` in @saga-ai/utils handles all story scanning including worktrees. The dashboard shows stories from worktrees. find.js resolves stories from worktrees. The two separate saga-scanner files are deleted. All tests pass.",
  "avoid": "Do not modify create-story.js or the worker pipeline — those stay as-is. Do not change where stories are written (worktrees). Do not change the epic scanning logic beyond using the existing `listEpics()`. Do not add async scanning — keep it sync.",
  "branch": "story/consolidate-story-scanning",
  "pr": "https://github.com/Roeia1/SAGA/pull/72",
  "worktree": ".saga/worktrees/consolidate-story-scanning/"
}
