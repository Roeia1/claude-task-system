#!/usr/bin/env bash
# task-status: Statusline integration script for Claude Task System
# Displays task context information for terminal prompts

set -euo pipefail

# Default configuration
USE_ICONS=true
SHOW_ORIGIN=false
SHOW_TASK=false
SHOW_COUNTS=false
SHOW_ALL=true

# Icons (Unicode)
ICON_MAIN="⎇"
ICON_WORKTREE="⌂"

# ASCII fallbacks
ASCII_MAIN="[M]"
ASCII_WORKTREE="[W]"

# Usage information
show_help() {
    cat << 'EOF'
Usage: task-status [OPTIONS]

Display Claude Task System context information for terminal statuslines.

Options:
  --help        Show this help message and exit
  --no-icons    Use ASCII characters instead of Unicode icons
  --origin      Show only the origin indicator (main repo vs worktree)
  --task        Show only the current task ID
  --counts      Show only task counts

If no section flags are specified, all sections are shown.

Environment:
  CLAUDE_ENV_FILE    Path to environment file with pre-detected context variables.
                     Expected variables: TASK_CONTEXT, CURRENT_TASK_ID

Examples:
  task-status                    # Show all sections with icons
  task-status --no-icons         # Show all sections with ASCII
  task-status --origin           # Show only origin indicator
  task-status --origin --task    # Show origin and task sections

Exit codes:
  0    Success
  1    Invalid arguments
EOF
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --help)
                show_help
                exit 0
                ;;
            --no-icons)
                USE_ICONS=false
                shift
                ;;
            --origin)
                SHOW_ORIGIN=true
                SHOW_ALL=false
                shift
                ;;
            --task)
                SHOW_TASK=true
                SHOW_ALL=false
                shift
                ;;
            --counts)
                SHOW_COUNTS=true
                SHOW_ALL=false
                shift
                ;;
            *)
                echo "Unknown option: $1" >&2
                echo "Use --help for usage information" >&2
                exit 1
                ;;
        esac
    done

    # If no section flags specified, show all
    if [[ "$SHOW_ALL" == "true" ]]; then
        SHOW_ORIGIN=true
        SHOW_TASK=true
        SHOW_COUNTS=true
    fi
}

# Source environment file if available
load_environment() {
    # Reset variables - only use values from CLAUDE_ENV_FILE, not inherited environment
    # This ensures consistent behavior regardless of outer environment
    TASK_CONTEXT=""
    CURRENT_TASK_ID=""

    # Check if CLAUDE_ENV_FILE is set and non-empty
    if [[ -n "${CLAUDE_ENV_FILE:-}" ]]; then
        # Check if file exists and is readable
        if [[ -f "$CLAUDE_ENV_FILE" && -r "$CLAUDE_ENV_FILE" ]]; then
            # Source the file, ignoring errors from malformed content
            # shellcheck disable=SC1090
            source "$CLAUDE_ENV_FILE" 2>/dev/null || true
        fi
    fi
}

# Output origin indicator
output_origin() {
    local indicator

    # Determine context (default to "main" if not set)
    local context="${TASK_CONTEXT:-main}"

    if [[ "$context" == "worktree" ]]; then
        if [[ "$USE_ICONS" == "true" ]]; then
            indicator="$ICON_WORKTREE"
        else
            indicator="$ASCII_WORKTREE"
        fi
    else
        # Default to main for any other value or unset
        if [[ "$USE_ICONS" == "true" ]]; then
            indicator="$ICON_MAIN"
        else
            indicator="$ASCII_MAIN"
        fi
    fi

    echo -n "$indicator"
}

# Output task ID
output_task() {
    if [[ -n "${CURRENT_TASK_ID:-}" ]]; then
        echo -n "$CURRENT_TASK_ID"
    fi
}

# Output task counts (placeholder for future implementation)
output_counts() {
    # Placeholder - will be implemented in future tasks
    :
}

# Main function
main() {
    parse_args "$@"
    load_environment

    local output=""
    local separator=" "

    if [[ "$SHOW_ORIGIN" == "true" ]]; then
        output+=$(output_origin)
    fi

    if [[ "$SHOW_TASK" == "true" ]]; then
        local task_output
        task_output=$(output_task)
        if [[ -n "$task_output" ]]; then
            if [[ -n "$output" ]]; then
                output+="$separator"
            fi
            output+="$task_output"
        fi
    fi

    if [[ "$SHOW_COUNTS" == "true" ]]; then
        local counts_output
        counts_output=$(output_counts)
        if [[ -n "$counts_output" ]]; then
            if [[ -n "$output" ]]; then
                output+="$separator"
            fi
            output+="$counts_output"
        fi
    fi

    if [[ -n "$output" ]]; then
        echo "$output"
    fi

    exit 0
}

main "$@"
